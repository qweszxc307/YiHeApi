<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.crown.projects.main.mapper.MarketRecommendMapper">
    <select id="selectRecommendProducts" parameterType="java.lang.String" resultType="org.crown.projects.main.model.dto.RecommendProductPageDTO">
        select a.active_pid,a.send_pid,a.carriage_price,a.member_name,a.active_name,a.active_stock,a.send_name,a.active_product_price,a.send_price,a.active_img_url,i.img_url send_img_url from (
            select mr.*,
            m.name member_name,
            p.name active_name,
            p.stock active_stock,
            (select name from product where product.id = mr.send_pid) send_name,
            pr.price active_product_price,
            (select price from product_price  where product_price.pid = mr.send_pid and product_price.s_num = 1) send_price,
            i.img_url active_img_url
                from market_recommend mr
                left join member m
                on m.id = mr.member_id
                left join product p
                on p.id = mr.active_pid
                left join product_price pr
                on pr.pid=p.id
                and pr.s_num = 1
                left join (select pi.p_id,pi.img_id from product_image pi inner join market_recommend mr on mr.active_pid = pi.p_id group BY mr.active_pid) pi
                on pi.p_id = mr.active_pid
                left join image i
                on i.id = pi.img_id
            )a
            inner join product_image pi
            on pi.p_id = a.send_pid
            inner join image i
            on i.id = pi.img_id
            where a.status = 0
            group by a.active_pid,a.send_pid
    </select>
</mapper>
